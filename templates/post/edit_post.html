{% extends "base.html" %}

{% block content %}
<div class="post-page">
    <div class="post-page-header">
        <h2><i class="fas fa-edit"></i> ç¼–è¾‘ä¸»é¢˜</h2>
        <p class="text-muted">ä¿®æ”¹æ‚¨çš„å¸–å­å†…å®¹ï¼Œå®Œå–„æ‚¨çš„æƒ³æ³•</p>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="POST" id="post-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- æ ‡é¢˜ -->
                <div class="form-group mb-4">
                    <label for="title" class="form-label">
                        <i class="fas fa-heading"></i> æ ‡é¢˜
                    </label>
                    <input type="text" class="form-control" id="title" name="title" placeholder="è¾“å…¥å¸–å­æ ‡é¢˜ï¼ˆ5-50ä¸ªå­—ç¬¦ï¼‰" value="{{ post.title }}" required>
                    <div class="form-text">ä¸€ä¸ªå¥½çš„æ ‡é¢˜èƒ½å¤Ÿå¸å¼•æ›´å¤šè¯»è€…</div>
                </div>

                <!-- ç‰ˆå—é€‰æ‹© -->
                <div class="form-group mb-4">
                    <label for="section_id" class="form-label">
                        <i class="fas fa-folder"></i> é€‰æ‹©ç‰ˆå—
                    </label>
                    <select class="form-control" id="section_id" name="section_id">
                        <option value="">-- è¯·é€‰æ‹©ç‰ˆå— --</option>
                        {% for section in sections %}
                        <option value="{{ section.id }}" {% if section.id == post.section_id %}selected{% endif %}>{{ section.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">é€‰æ‹©ä¸€ä¸ªé€‚åˆæ‚¨è¯é¢˜çš„ç‰ˆå—</div>
                </div>

                <!-- å†…å®¹ -->
                <div class="form-group mb-4">
                    <label for="content" class="form-label">
                        <i class="fas fa-pencil-alt"></i> å†…å®¹
                        <span class="markdown-support">æ”¯æŒ Markdown æ ¼å¼</span>
                    </label>
                    <div class="content-editor">
                        <div class="editor-toolbar">
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('**', '**', 'ç²—ä½“æ–‡æœ¬')" title="ç²—ä½“">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('*', '*', 'æ–œä½“æ–‡æœ¬')" title="æ–œä½“">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('### ', '', 'æ ‡é¢˜')" title="æ ‡é¢˜">
                                <i class="fas fa-heading"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('[', '](URL)', 'é“¾æ¥æ–‡æœ¬')" title="é“¾æ¥">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('![alt text](', ')', 'https://å›¾ç‰‡é“¾æ¥')" title="å›¾ç‰‡">
                                <i class="fas fa-image"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('```\n', '\n```', 'ä»£ç å—')" title="ä»£ç å—">
                                <i class="fas fa-code"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('> ', '', 'å¼•ç”¨æ–‡æœ¬')" title="å¼•ç”¨">
                                <i class="fas fa-quote-right"></i>
                            </button>
                            <button type="button" class="toolbar-btn" id="emojiButton" title="æ·»åŠ è¡¨æƒ…">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('::: tip\n', '\n:::', 'ä»£ç å—')" title="ä¿¡æ¯å—-æç¤º">
                                <i class="fa-solid fa-lightbulb"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('::: info\n', '\n:::', 'ä»£ç å—')" title="ä¿¡æ¯å—-ä¿¡æ¯">
                                <i class="fa-solid fa-circle-info"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('::: warning\n', '\n:::', 'ä»£ç å—')" title="ä¿¡æ¯å—-è­¦å‘Š">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertMarkdown('::: danger\n', '\n:::', 'ä»£ç å—')" title="ä¿¡æ¯å—-å±é™©">
                                <i class="fa-solid fa-skull"></i>
                            </button>
                        </div>
                        <textarea class="form-control" id="content" name="content" rows="12" placeholder="è¾“å…¥å¸–å­å†…å®¹" required>{{ post.content }}</textarea>
                        <div class="form-text">æ·»åŠ ä¸°å¯Œçš„å†…å®¹ï¼Œæ”¯æŒ Markdown æ ¼å¼ï¼Œå¯ä»¥æ’å…¥ä»£ç ã€å›¾ç‰‡å’Œé“¾æ¥</div>
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                    </button>
                    <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-outline">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </a>
                </div>
            </form>

            <!-- Emoji å¼¹å‡ºæ¡† -->
            <div id="emojiPopup" class="emoji-popup">
                <div class="emoji-popup-header">
                    <span>å¸¸ç”¨è¡¨æƒ…</span>
                    <button type="button" class="emoji-close-btn" onclick="hideEmojiPopup()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="emoji-popup-content">
                    <span class="emoji">ğŸ˜€</span>
                    <span class="emoji">ğŸ˜Š</span>
                    <span class="emoji">ğŸ˜</span>
                    <span class="emoji">ğŸ¤”</span>
                    <span class="emoji">ğŸ˜</span>
                    <span class="emoji">ğŸ™‚</span>
                    <span class="emoji">ğŸ˜</span>
                    <span class="emoji">ğŸ˜‰</span>
                    <span class="emoji">ğŸ‘</span>
                    <span class="emoji">ğŸ‘</span>
                    <span class="emoji">â¤ï¸</span>
                    <span class="emoji">ğŸ‰</span>
                    <span class="emoji">ğŸ”¥</span>
                    <span class="emoji">ğŸ’¯</span>
                    <span class="emoji">ğŸš€</span>
                    <span class="emoji">ğŸ’¡</span>
                </div>
                <div class="emoji-popup-footer">
                    æŒ‰ <kbd>Ctrl</kbd>+<kbd>:</kbd> æ‰“å¼€è¡¨æƒ…èœå•
                </div>
            </div>
        </div>
    </div>
</div>

<div class="markdown-preview-panel">
    <div class="preview-header">
        <h3>é¢„è§ˆ</h3>
        <button type="button" class="close-preview-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="preview-content markdown-content"></div>
</div>

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/post.css') }}">
<script src="{{ url_for('static', filename='js/emoji_interact.js') }}"></script>
<script>
    // Markdown ç¼–è¾‘å™¨åŠŸèƒ½
    function insertMarkdown(before, after, placeholder) {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        const replacement = before + (selectedText || placeholder) + after;

        textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);

        // è®¾ç½®å…‰æ ‡ä½ç½®
        const newPosition = selectedText ? start + replacement.length : start + before.length + placeholder.length;
        textarea.focus();
        textarea.selectionStart = newPosition;
        textarea.selectionEnd = newPosition;

        // è§¦å‘å†…å®¹å˜åŒ–äº‹ä»¶
        textarea.dispatchEvent(new Event('input'));
    }

    // é¢„è§ˆåŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const previewPanel = document.querySelector('.markdown-preview-panel');
        const previewContent = document.querySelector('.preview-content');
        const closeBtn = document.querySelector('.close-preview-btn');
        const textarea = document.getElementById('content');

        // æ·»åŠ å®æ—¶é¢„è§ˆæŒ‰é’®
        const toolbar = document.querySelector('.editor-toolbar');
        const previewBtn = document.createElement('button');
        previewBtn.type = 'button';
        previewBtn.className = 'toolbar-btn preview-btn';
        previewBtn.title = 'é¢„è§ˆ';
        previewBtn.innerHTML = '<i class="fas fa-eye"></i>';
        toolbar.appendChild(previewBtn);

        // é¢„è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        previewBtn.addEventListener('click', function() {
            if (previewPanel.classList.contains('active')) {
                previewPanel.classList.remove('active');
            } else {
                updatePreview();
                previewPanel.classList.add('active');
            }
        });

        // å…³é—­é¢„è§ˆ
        closeBtn.addEventListener('click', function() {
            previewPanel.classList.remove('active');
        });

        // æ›´æ–°é¢„è§ˆå†…å®¹
        function updatePreview() {
            // ç®€å•çš„Markdownè½¬HTMLå®ç°
            let html = textarea.value
                .replace(/#{3}\s*(.*?)\s*$/gm, '<h3>$1</h3>')
                .replace(/#{2}\s*(.*?)\s*$/gm, '<h2>$1</h2>')
                .replace(/#{1}\s*(.*?)\s*$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">')
                .replace(/`{3}([\s\S]*?)`{3}/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^>\s*(.*?)$/gm, '<blockquote>$1</blockquote>')
                .replace(/\n/g, '<br>');

            previewContent.innerHTML = html;
        }

        // ç›‘å¬æ–‡æœ¬å˜åŒ–
        textarea.addEventListener('input', function() {
            if (previewPanel.classList.contains('active')) {
                updatePreview();
            }
        });

        // åˆå§‹åŠ è½½æ—¶æ›´æ–°é¢„è§ˆ
        updatePreview();
    });
</script>
{% endblock %}